# Render.com Deployment Guide

This guide will help you deploy the HeartBeat Tracker application on Render.com.

## Prerequisites

- A Render.com account (free tier is sufficient)
- GitHub repository with your code
- Render PostgreSQL database (free tier available)

## Step 1: Prepare Your Repository

1. **Push your code to GitHub**:
   ```bash
   git add .
   git commit -m "Ready for Render deployment"
   git push origin main
   ```

2. **Ensure all files are committed**:
   - `render.yaml` - Render configuration
   - `requirements.txt` - Python dependencies
   - `init_db.py` - Database initialization script
   - `run.py` - Application startup script
   - `.env.example` - Environment variables template

## Step 2: Set Up PostgreSQL Database

1. **Create a new PostgreSQL service** on Render:
   - Go to Render Dashboard → New → PostgreSQL
   - Choose a name (e.g., `heartbeat-db`)
   - Select free tier
   - Choose a region
   - Click "Create PostgreSQL Database"

2. **Get the database URL**:
   - Once created, go to the database service
   - Copy the "Internal Database URL" (starts with `postgresql://`)

## Step 3: Deploy the Web Service

1. **Create a new Web Service** on Render:
   - Go to Render Dashboard → New → Web Service
   - Connect your GitHub repository
   - Choose the branch to deploy (usually `main`)
   - Render will automatically detect the `render.yaml` file

2. **Configure environment variables**:
   - Go to your web service → Environment
   - Add the `DATABASE_URL` from Step 2
   - Ensure `BEARER_TOKEN` is set (Render will auto-generate one)
   - Other variables are already configured in `render.yaml`

3. **Deploy**:
   - Click "Create Web Service"
   - Render will automatically build and deploy your application

## Step 4: Verify Deployment

1. **Check the deployment logs**:
   - Go to your web service → Logs
   - Look for successful database initialization messages
   - Check for any errors

2. **Test the application**:
   - Visit your application URL (e.g., `https://heartbeat-tracker.onrender.com`)
   - Test the dashboard: `/dashboard`
   - Test settings: `/settings`
   - Test health check: `/health`

## Step 5: Post-Deployment Setup

1. **Get your BEARER_TOKEN**:
   - Go to your web service → Environment
   - Copy the generated `BEARER_TOKEN`

2. **Configure heartbeat agent**:
   - Update your local `.env` file with the production URL
   - Set `SERVER_URL=https://your-app.onrender.com`
   - Use the production `BEARER_TOKEN`

3. **Test heartbeat**:
   ```bash
   python app/agent/heartbeat.py --once
   ```

## Environment Variables

The following environment variables are automatically configured by `render.yaml`:

- `HOST`: 0.0.0.0 (Render requirement)
- `PORT`: 10000 (Render default)
- `RELOAD`: false (Production setting)
- `DATABASE_URL`: Your PostgreSQL connection string
- `BEARER_TOKEN`: Auto-generated authentication token
- `DEVICE_ID`: DEFAULT
- `LOG_LEVEL`: INFO

## Database Initialization

The application automatically initializes the database on startup:
- SQLAlchemy creates tables based on models in `app/models.py`
- Default settings are created (8 hours, Mon-Fri work week)
- Time required values are populated for all dates
- No manual database setup required

## Troubleshooting

### Common Issues:

1. **Database connection error**:
   - Verify `DATABASE_URL` is correct
   - Check if database is running
   - Ensure database URL format is correct

2. **Build fails**:
   - Check `requirements.txt` for correct versions
   - Verify all Python files are syntactically correct
   - Check deployment logs for specific errors

3. **Application not starting**:
   - Check if database initialization completed
   - Verify all environment variables are set
   - Look for errors in startup logs

4. **Heartbeat not working**:
   - Verify `BEARER_TOKEN` matches between agent and server
   - Check if `SERVER_URL` is correct in agent
   - Test health endpoint: `https://your-app.onrender.com/health`

### Useful Commands:

```bash
# Test health endpoint
curl https://your-app.onrender.com/health

# Check logs on Render
# Go to your service → Logs tab

# Redeploy after changes
# Go to your service → Manual Deploy → Deploy latest commit
```

## Scaling

The free tier includes:
- 750 hours of build time per month
- 512MB RAM for web service
- 256MB RAM for PostgreSQL database
- 90GB of data transfer

For production use, consider upgrading to paid tiers for better performance and reliability.

## Security Notes

- The `BEARER_TOKEN` is automatically generated by Render
- Keep your token secret and only share with trusted devices
- Consider rotating tokens periodically
- Use HTTPS (automatically provided by Render)

## Support

If you encounter issues:
1. Check Render documentation: https://render.com/docs
2. Review deployment logs
3. Verify environment variables
4. Test locally with same configuration
